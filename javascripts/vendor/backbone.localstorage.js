!function(e,t){"object"==typeof exports&&"function"==typeof require?module.exports=t(require("backbone"),require("underscore")):"function"==typeof define&&define.amd?define(["backbone","underscore"],function(r,i){return t(r||e.Backbone,i||e._)}):t(Backbone,_)}(this,function(e,t){function r(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function i(){return r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r()}function o(e,t){for(var r=e.length;r--;)if(e[r]===t)return!0;return!1}function n(e,t){for(var r in t)e[r]=t[r];return e}return e.LocalStorage=window.Store=function(e,r){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=e,this.serializer=r||{serialize:function(e){return t.isObject(e)?JSON.stringify(e):e},deserialize:function(e){return e&&JSON.parse(e)}};var i=this.localStorage().getItem(this.name);this.records=i&&i.split(",")||[]},n(e.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=i(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e)),this.records.push(e.id.toString()),this.save(),this.find(e)!==!1},update:function(e){this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e));var t=e.id.toString();return o(this.records,t)||(this.records.push(t),this.save()),this.find(e)!==!1},find:function(e){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(e.id)))},findAll:function(){for(var e,t,r=[],i=0;i<this.records.length;i++)e=this.records[i],t=this.serializer.deserialize(this.localStorage().getItem(this._itemName(e))),null!=t&&r.push(t);return r},destroy:function(e){this.localStorage().removeItem(this._itemName(e.id));for(var t=e.id.toString(),r=0;r<this.records.length;r++)this.records[r]===t&&this.records.splice(r,1);return this.save(),e},localStorage:function(){return localStorage},_clear:function(){var e=this.localStorage(),t=new RegExp("^"+this.name+"-");e.removeItem(this.name);for(var r in e)t.test(r)&&e.removeItem(r);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(e){return this.name+"-"+e}}),e.LocalStorage.sync=window.Store.sync=e.localSync=function(t,r,i){var o,n,s=r.localStorage||r.collection.localStorage,a=e.$?e.$.Deferred&&e.$.Deferred():e.Deferred&&e.Deferred();try{switch(t){case"read":o=void 0!=r.id?s.find(r):s.findAll();break;case"create":o=s.create(r);break;case"update":o=s.update(r);break;case"delete":o=s.destroy(r)}}catch(c){n=22===c.code&&0===s._storageSize()?"Private browsing is unsupported":c.message}return o?(i&&i.success&&("0.9.10"===e.VERSION?i.success(r,o,i):i.success(o)),a&&a.resolve(o)):(n=n?n:"Record Not Found",i&&i.error&&("0.9.10"===e.VERSION?i.error(r,n,i):i.error(n)),a&&a.reject(n)),i&&i.complete&&i.complete(o),a&&a.promise()},e.ajaxSync=e.sync,e.getSyncMethod=function(t){return t.localStorage||t.collection&&t.collection.localStorage?e.localSync:e.ajaxSync},e.sync=function(t,r,i){return e.getSyncMethod(r).apply(this,[t,r,i])},e.LocalStorage});